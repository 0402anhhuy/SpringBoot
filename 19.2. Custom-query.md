# ğŸŒ± Custom Query

## ğŸ§¨ Má»¥c Ä‘Ã­ch cá»§a **`@Query`**

> DÃ¹ng khi muá»‘n **viáº¿t cÃ¢u truy váº¥n tÃ¹y chá»‰nh** thay vÃ¬ Ä‘á»ƒ Spring tá»± suy luáº­n qua tÃªn hÃ m

- ÄÆ°á»£c dÃ¹ng trong `Repository` Ä‘á»ƒ viáº¿t truy váº¥n SQL hoáº·c JPQL

  - Truy váº¥n phá»©c táº¡p (join, group by, limit)

  - KhÃ´ng thá»ƒ diá»…n táº£ báº±ng tÃªn hÃ m

  - Cáº§n dÃ¹ng `JOIN`, `SUBQUERY`, `ORDER`,...

## ğŸ‘ Giáº£i thÃ­ch chi tiáº¿t

| ThÃ nh pháº§n                      | Ã nghÄ©a                                           |
| ------------------------------- | ------------------------------------------------- |
| `@Query(...)`                   | Viáº¿t truy váº¥n theo kiá»ƒu **JPQL**                  |
| `"SELECT p FROM Product p"`     | Chá»n táº¥t cáº£ tá»« **entity `Product`**, alias lÃ  `p` |
| `WHERE p.price > :min`          | Äiá»u kiá»‡n lá»c: `price` lá»›n hÆ¡n giÃ¡ trá»‹ `:min`     |
| `:min`                          | **Biáº¿n bind** (Ä‘Æ°á»£c gÃ¡n tá»« `@Param("min")`)       |
| `@Param("min") double minPrice` | Tham sá»‘ truyá»n vÃ o tá»« method                      |

### ğŸ” LÆ°u Ã½

- **JPQL**: LÃ  ngÃ´n ngá»¯ truy váº¥n Ä‘á»‘i tÆ°á»£ng, lÃ m viá»‡c vá»›i **entity** vÃ  **field** thay vÃ¬ báº£ng vÃ  cá»™t
- **SQL**: LÃ  ngÃ´n ngá»¯ truy váº¥n cÆ¡ sá»Ÿ dá»¯ liá»‡u, lÃ m viá»‡c vá»›i **báº£ng** vÃ  **cá»™t**

| JPQL (Java Persistence Query Language) | SQL truyá»n thá»‘ng           |
| -------------------------------------- | -------------------------- |
| DÃ¹ng tÃªn **entity** vÃ  **field**       | DÃ¹ng tÃªn báº£ng vÃ  cá»™t       |
| `Product`, `price`                     | `product`, `product_price` |
| `SELECT p FROM Product p`              | `SELECT * FROM product`    |

## ğŸª€ CÃ¡ch truyá»n biáº¿n trong `@Query`

| CÃ¡ch thá»©c                | CÃº phÃ¡p                 |
| ------------------------ | ----------------------- |
| **Named parameter**      | `:min`, `@Param("min")` |
| **Positional parameter** | `?1`, `?2`              |

- DÃ¹ng vá»›i nhiá»u Ä‘iá»u kiá»‡n

```java
@Query("SELECT p FROM Product p WHERE p.name LIKE %:keyword% AND p.price BETWEEN :min AND :max")
List<Product> search(@Param("keyword") String keyword, @Param("min") Double min, @Param("max") Double max);
```

## ğŸ§« Native SQL query

> Khi cáº§n truy váº¥n **SQL chuáº©n** (khÃ´ng qua entity)

```java
@Query(value = "SELECT * FROM product WHERE price > :min", nativeQuery = true)
List<Product> rawQuery(@Param("min") double min);
```

## âš ï¸ LÆ°u Ã½

| Cáº©n tháº­n                                      | VÃ¬ sao                               |
| --------------------------------------------- | ------------------------------------ |
| Sai tÃªn entity hoáº·c field â†’ lá»—i runtime       | JPQL dÃ¹ng class, khÃ´ng dÃ¹ng tÃªn báº£ng |
| KhÃ´ng truyá»n Ä‘Ãºng tÃªn `@Param(...)`           | GÃ¢y lá»—i query khÃ´ng bind biáº¿n        |
| NÃªn test truy váº¥n ká»¹ trÆ°á»›c khi Ä‘Æ°a production | âœ”ï¸                                   |

---

ğŸ“Œ Báº¡n muá»‘n mÃ¬nh viáº¿t:

- Má»™t `@Query` dÃ¹ng `JOIN`
- Má»™t custom query lá»c sáº£n pháº©m theo nhiá»u tiÃªu chÃ­ (keyword + price + category)?

ğŸ‘‰ Chá»‰ cáº§n nÃ³i **â€œLÃ m query nÃ¢ng cao vá»›i joinâ€**, mÃ¬nh build cho báº¡n luÃ´n nhÃ© ğŸ”§ğŸ¤–

```

```
