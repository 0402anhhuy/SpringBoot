# üå± Custom Query

## üß® M·ª•c ƒë√≠ch c·ªßa **`@Query`**

> D√πng khi mu·ªën **vi·∫øt c√¢u truy v·∫•n t√πy ch·ªânh** thay v√¨ ƒë·ªÉ Spring t·ª± suy lu·∫≠n qua t√™n h√†m

- ƒê∆∞·ª£c d√πng trong `Repository` ƒë·ªÉ vi·∫øt truy v·∫•n SQL ho·∫∑c JPQL

  - Truy v·∫•n ph·ª©c t·∫°p (join, group by, limit)

  - Kh√¥ng th·ªÉ di·ªÖn t·∫£ b·∫±ng t√™n h√†m

  - C·∫ßn d√πng `JOIN`, `SUBQUERY`, `ORDER`,...

## üéë Gi·∫£i th√≠ch chi ti·∫øt

| Th√†nh ph·∫ßn                      | √ù nghƒ©a                                           |
| ------------------------------- | ------------------------------------------------- |
| `@Query(...)`                   | Vi·∫øt truy v·∫•n theo ki·ªÉu **JPQL**                  |
| `"SELECT p FROM Product p"`     | Ch·ªçn t·∫•t c·∫£ t·ª´ **entity `Product`**, alias l√† `p` |
| `WHERE p.price > :min`          | ƒêi·ªÅu ki·ªán l·ªçc: `price` l·ªõn h∆°n gi√° tr·ªã `:min`     |
| `:min`                          | **Bi·∫øn bind** (ƒë∆∞·ª£c g√°n t·ª´ `@Param("min")`)       |
| `@Param("min") double minPrice` | Tham s·ªë truy·ªÅn v√†o t·ª´ method                      |

### üîç L∆∞u √Ω

- **JPQL**: L√† ng√¥n ng·ªØ truy v·∫•n ƒë·ªëi t∆∞·ª£ng, l√†m vi·ªác v·ªõi **entity** v√† **field** thay v√¨ b·∫£ng v√† c·ªôt
- **SQL**: L√† ng√¥n ng·ªØ truy v·∫•n c∆° s·ªü d·ªØ li·ªáu, l√†m vi·ªác v·ªõi **b·∫£ng** v√† **c·ªôt**

| JPQL (Java Persistence Query Language) | SQL truy·ªÅn th·ªëng           |
| -------------------------------------- | -------------------------- |
| D√πng t√™n **entity** v√† **field**       | D√πng t√™n b·∫£ng v√† c·ªôt       |
| `Product`, `price`                     | `product`, `product_price` |
| `SELECT p FROM Product p`              | `SELECT * FROM product`    |

## ü™Ä C√°ch truy·ªÅn bi·∫øn trong `@Query`

| C√°ch th·ª©c                | C√∫ ph√°p                 |
| ------------------------ | ----------------------- |
| **Named parameter**      | `:min`, `@Param("min")` |
| **Positional parameter** | `?1`, `?2`              |

- D√πng v·ªõi nhi·ªÅu ƒëi·ªÅu ki·ªán

```java
@Query("SELECT p FROM Product p WHERE p.name LIKE %:keyword% AND p.price BETWEEN :min AND :max")
List<Product> search(@Param("keyword") String keyword, @Param("min") Double min, @Param("max") Double max);
```

## üß´ Native SQL query

> Khi c·∫ßn truy v·∫•n **SQL chu·∫©n** (kh√¥ng qua entity)

```java
@Query(value = "SELECT * FROM product WHERE price > :min", nativeQuery = true)
List<Product> rawQuery(@Param("min") double min);
```
