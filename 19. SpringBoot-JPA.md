# üå± Spring Boot - JPA

## üßâ Gi·ªõi thi·ªáu v·ªÅ JPA

> **JPA (Java Persistence API)** l√† chu·∫©n Java ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi **database** **(ORM ‚Äì Object Relational Mapping)**

- Cho ph√©p d√πng `@Entity`, `@Repository`, `@Id`,... ƒë·ªÉ √°nh x·∫° d·ªØ li·ªáu Java ‚Üî SQL

- Gi√∫p thao t√°c v·ªõi **`database`** m·ªôt c√°ch d·ªÖ d√†ng h∆°n, t·ª± ƒë·ªông config v√† gi·∫£m thi·ªÉu code th·ª´a th√£i (l√†m vi·ªác v·ªõi DB qua c√°c **class v√† interface Java**)

- L√† m·ªôt ph·∫ßn trong h·ªá sinh th√°i **`Spring Data`**

- N√≥ t·∫°o ra m·ªôt t·∫ßng ·ªü gi·ªØa t·∫ßng **`service`** v√† **`database`**

- Framework ph·ªï bi·∫øn nh·∫•t hi·ªán th·ª±c JPA l√†: **Hibernate**

## üçÆ C√†i ƒë·∫∑t JPA

- Th√™m dependency v√†o **`pom.xml`**

```xml
<!-- Spring Data JPA -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-jpa</artifactId>
</dependency>
```

## üç∏ ·ª®ng d·ª•ng c·ªßa JPA

| T√≠nh nƒÉng                       | M√¥ t·∫£                                                  |
| ------------------------------- | ------------------------------------------------------ |
| ORM (Object-Relational Mapping) | Map class ‚Üî table, field ‚Üî column                      |
| CRUD                            | T·ª± ƒë·ªông th√™m, s·ª≠a, x√≥a, t√¨m b·∫±ng repository            |
| Mapping quan h·ªá                 | `@OneToMany`, `@ManyToOne`, `@OneToOne`, `@ManyToMany` |
| Query m·∫°nh                      | `@Query`, `JPQL`, `Native SQL`                         |
| Transaction                     | T√≠ch h·ª£p `@Transactional`                              |

## üçà C·∫•u tr√∫c JPA trong Spring Boot

**`Product.java`**

```java
@Entity
@Table(name="product")
public class Product {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false)
    private String name;

    private Double price;
}
```

## üçÑ Repository - thao t√°c v·ªõi DB

**`ProductRepository.java`**

```java
public interface ProductRepository extends JpaRepository<Product, Long> {
    List<Product> findByNameContaining(String name);
}
```

> T·ª± sinh c√°c ph∆∞∆°ng th·ª©c nh∆∞ `save()`, `findAll()`, `deleteById()`, `findById()`, `existsById()`,...

## ü•É C√°c annotation quan tr·ªçng

| Annotation         | M√¥ t·∫£                                         |
| ------------------ | --------------------------------------------- |
| `@Entity`          | ƒê√°nh d·∫•u 1 class l√† 1 b·∫£ng                    |
| `@Id`              | Kh√≥a ch√≠nh                                    |
| `@GeneratedValue`  | Chi·∫øn l∆∞·ª£c t·ª± tƒÉng (AUTO, IDENTITY, SEQUENCE) |
| `@Column`          | T√πy ch·ªânh t√™n, ki·ªÉu, nullable, unique         |
| `@Table(name=...)` | ƒê·ªïi t√™n b·∫£ng                                  |
| `@Transient`       | Kh√¥ng map c·ªôt n√†y v√†o DB                      |
| `@Lob`             | D√πng cho text d√†i, image                      |
| `@Temporal`        | Format cho `Date`                             |
| `@Enumerated`      | Format Enum l∆∞u v√†o DB                        |

## üçá CRUD v·ªõi JPA

```java
// Th√™m
productRepository.save(product);

// T√¨m t·∫•t c·∫£
List<Product> list = productRepository.findAll();

// T√¨m theo ID
Optional<Product> product = productRepository.findById(1L);

// X√≥a
productRepository.deleteById(1L);
```

## üåº √Ånh x·∫° m·ªëi quan h·ªá

| Annotation    | M·ªëi quan h·ªá               |
| ------------- | ------------------------- |
| `@OneToMany`  | 1 ‚Üí nhi·ªÅu (User ‚Üí Orders) |
| `@ManyToOne`  | nhi·ªÅu ‚Üí 1 (Order ‚Üí User)  |
| `@OneToOne`   | 1 ‚Üî 1                     |
| `@ManyToMany` | nhi·ªÅu ‚Üî nhi·ªÅu             |

- K·∫øt h·ª£p v·ªõi `@JoinColumn`, `@MappedBy`, `CascadeType`, `FetchType`

## üçµ Truy v·∫•n d·ªØ li·ªáu n√¢ng cao

### üìå Derived query method ‚Äì truy v·∫•n b·∫±ng c√°ch ƒë·∫∑t t√™n ph∆∞∆°ng th·ª©c

```java
List<Product> findByNameContaining(String keyword);
Product findByIdAndName(Long id, String name);
```

Chi ti·∫øt [Derived query method](19.1.%20Derived-query-method.md)

### üìå Custom query - truy v·∫•n SQL/JPQL t√πy ch·ªânh

```java
@Query("SELECT p FROM Product p WHERE p.price > :min")
List<Product> findExpensive(@Param("min") double minPrice);
```

Chi ti·∫øt [Custom query](19.2.%20Custom-query.md)

## üå≥ C·∫•u h√¨nh Hibernate (Spring JPA d√πng Hibernate ng·∫ßm)

```properties
# T·ª± ƒë·ªông t·∫°o/update b·∫£ng
spring.jpa.hibernate.ddl-auto=update

# In SQL ra console
spring.jpa.show-sql=true

# Format SQL cho d·ªÖ nh√¨n
spring.jpa.properties.hibernate.format_sql=true
```

| Gi√° tr·ªã `ddl-auto` | T√°c d·ª•ng                      |
| ------------------ | ----------------------------- |
| `none`             | Kh√¥ng ƒë·ªông g√¨ t·ªõi DB          |
| `create`           | X√≥a b·∫£ng c≈©, t·∫°o m·ªõi          |
| `create-drop`      | T·∫°o khi start, drop khi stop  |
| `update`           | Th∆∞·ªùng d√πng khi dev           |
| `validate`         | So s√°nh schema, n·∫øu sai ‚Üí l·ªói |

## üçí Transaction Management

```java
@Service
@Transactional
public class ProductService {
    public void saveProduct(Product p) {
        productRepository.save(p);
    }
}
```

> D√πng `@Transactional` ƒë·ªÉ ƒë·∫£m b·∫£o rollback khi l·ªói x·∫£y ra
